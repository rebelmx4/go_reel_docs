#### 1. 功能概述 (Feature Overview)

“创建标签”是本软件知识管理体系的核心功能。它允许用户从视频的特定帧画面出发，创建一个包含**封面图片、全局唯一关键词、可选描述、并隶属于特定分组**的丰富标签。

本功能的设计核心是**“上下文感知创建” (Context-Aware Creation)**。它通过一个集成的界面，让用户在输入新标签信息的同时，能实时参考“本视频已分配的标签”和“整个标签库的现有内容”，从而最大限度地避免重复创建，保证标签体系的整洁与高效。

#### 2. 触发机制 (Triggering Mechanism)

该功能完全由鼠标在播放器视口中的操作触发，流程如下：

1. 在视频播放器的主画面区域，用户**按下并按住鼠标左键**。
2. **拖动鼠标**，一个半透明的矩形选框会随之出现。
3. 用户框选出想要作为标签基础画面的区域后，**释放鼠标左键**。
4. 释放后，“创建标签”对话框将立即以模态形式弹出。

#### 3. UI 布局与设计原理 (UI Layout & Design Rationale)

对话框采用**左右布局**。这种布局经过精心设计，旨在将“**创造性输入**”与“**参考性浏览**”两个核心任务并行处理，减少用户的视线移动和认知负荷。

- **左侧：定义与创建区 (Creation Pane)**：用户在此区域完成新标签的所有数据输入。
- **右侧：上下文与参考区 (Reference Pane)**：用户在此区域获取所有必要的参考信息，以辅助创建决策。

```
+----------------------------------------------------------------------------------+
| 新建标签                                                                    [X]  |
+----------------------------------------------------------------------------------+
| [ 左侧：定义与创建区 ]                      | [ 右侧：上下文与参考区 ]            |
|                                             |                                  |
| +-----------------------------------------+ | ┌────────────────────────────────┐ |
| | [用户框选的视频画面]                    | | │ 本视频已分配标签 (3)             │ |
| | (可通过 Ctrl+C 替换)                      | | │ ... (标签卡片) ...             │ |
| +-----------------------------------------+ | │ └────────────────────────────────┘ |
|                                             |                                  |
| * 关键词 (必填)                             | │ ┌────────────────────────────────┐ |
| [ 输入关键词以创建或过滤...               ] | │ │ 标签库 (过滤结果)              │ |
|                                             | │ └────────────────────────────────┘ |
| * 描述 (可选)                               | │ [ 通用标签过滤与展示组件 ]         │ |
| [ 输入标签的详细描述...                   ] | │                                  │ |
|                                             |                                  |
| * 归属分组 (必填)                           | |                                  |
| +-----------------------------------------+ | |                                  |
| | [ 🔍 过滤或创建分组... ]                | | |                                  |
| +-----------------------------------------+ | |                                  |
| | 🏞️ 风景 (已选中)                      | | |                                  |
| | 📘 人物                               | | |                                  |
| | 🎬 影视                               | | |                                  |
| | ... (可滚动列表) ...                    | | |                                  |
| +-----------------------------------------+ | |                                  |
+---------------------------------------------+----------------------------------+
|                                                               [ 取消 ] [ 确定 ]  |
+----------------------------------------------------------------------------------+```
+----------------------------------------------------------------------------------+
```

#### 4. 核心交互工作流 (Core Interactive Workflow)

1. **启动**：用户通过拖拽释放操作，打开对话框。左侧的封面预览会自动填充为用户框选的画面。
2. **输入与过滤**：用户将焦点置于左侧的“关键词”输入框，开始输入，例如 樱花。
3. **实时反馈**：在用户输入的同时，右侧的“通用标签过滤与展示组件”会**立即**根据输入内容 樱花 进行过滤，实时展示出标签库中所有包含“樱花”的已有标签，例如 夜樱、樱花大道 等。
4. **决策**：
   - **情况A (发现重复)**：用户看到已有非常相似的标签，决定放弃创建。他可以点击【取消】关闭对话框。
   - **情况B (继续创建)**：用户确认自己要创建的标签（如 樱花特写）是新的。他继续完成信息填写。
5. **补充信息**：用户可以按需填写“描述”区域，并从“归属分组”的组合框中选择一个已有分组，或直接输入一个全新的分组名。
6. **替换封面 (可选)**：如果用户对框选的画面不满意，可以在任意时刻复制一个图片URL或本地图片文件路径，然后激活对话框窗口，按下 Ctrl+C。系统会自动检测剪贴板内容，若合法，则将左侧的封面预览替换为新图片。
7.  **选择分组**：用户将视线移到左下方的“归属分组”区域。所有现有的分组已经**直接展示**出来。    
   1.  **直接选择**：用户可以直接在列表中点击一个已有分组（如 `风景`）来完成选择。    
   2. **过滤选择**：如果分组很多，用户可以在顶部的搜索框中输入 `人`，列表会立即筛选出 `人物` 分组，然后点击选择。    
   3.  **创建新分组**：用户在搜索框中输入了一个全新的名字，如 `地点`，列表会提示创建新分组的选项，点击即可“预选”这个新分组。
8. **提交**：用户点击【确定】按钮。系统将执行严格的验证，通过后完成标签的创建和分配。

#### 5. 关键组件详解 (Key Component Breakdown)

- **封面预览区**
  - **默认内容**：用户在视频上框选的画面。
  - **替换机制 (Ctrl+C)**：当对话框处于激活状态且焦点不在输入框内时，Ctrl+C 会被拦截。系统会检查剪贴板内容：
    - 如果是合法的图片URL，则尝试下载并替换预览。
    - 如果是本地文件路径且指向一张图片，则加载并替换预览。
    - 否则，无操作。
- **统一关键词输入框**
  - **双重职责**：它既是**新标签的名称输入框**，也是驱动右侧标签库进行**实时过滤的控制器**。这是整个设计的核心，确保了输入与参考的无缝衔接。
  - **验证**：提交时，其内容必须全局唯一（不区分大小写）。
- **归属分组组合框 (ComboBox)**
  1.  **结构**:    
     1.  **顶部输入框**: 一个始终可见的文本输入框，其占位符为 `[🔍 过滤或创建分组...]`。    
     1.  **下方列表区**: 一个可滚动的列表，默认显示所有已创建的标签分组。 
  2. **交互逻辑**:    
     1.   **过滤 (Filtering)**：当用户在顶部输入框中键入文字时，下方的列表会**实时过滤**，仅显示名称包含输入文本的分组。    
     2.   **选择 (Selecting)**：        
        -   用户可以直接用鼠标**点击**列表中的任意一个分组项来选中它。        
        -   被选中的项会有一个清晰的**高亮背景**，表示当前选择。    
     3.  **创建 (Creating)**：这是此组件设计的精髓。       
        - 当用户在输入框中输入的文本**在现有分组中无任何匹配项**时，列表内容会发生变化。        
        -  列表的第一行（也可能是唯一一行）会变成一个特殊的、可点击的选项，例如：**`+ 创建新分组 "地点"`**。        
        -  用户点击这个特殊选项，就相当于“选中”了这个尚未创建的新分组。在视觉上，这个特殊选项也会被高亮。 
        -  **状态管理**：该组件内部始终维护一个“当前选中值”。这个值要么是一个已存在的的分组名，要么是将要创建的新分组名字符串。这个状态将用于最终的提交验证。
- **本视频已分配标签区**
  - **目的**：提供直接的上下文，防止用户为视频重复打上语义相近的标签。
  - **交互**：每个标签卡片右下角带有一个 ⓧ 图标，点击可立即将该标签从此视频中移除（取消分配）。

#### 6. 验证与提交逻辑 (Validation & Submission Logic)

当用户点击【确定】按钮时，系统会依次执行以下检查：

1. **关键词检查**：
   - 是否为空？-> 若是，则阻止提交，并提示用户填写。
   - 是否已在全局标签库中存在？-> 若是，则阻止提交，并高亮提示关键词冲突。
2. **分组检查**：
   - 用户是否已选择或输入了一个分组名？-> 若否，则阻止提交，并提示用户必须指定分组。

所有检查通过后，执行以下操作：

1. **数据持久化** (详见下一节)。
2. **自动分配**：新创建的标签会自动分配给当前视频。
3. 关闭对话框，并可能弹出一个全局的Toast提示“标签创建成功”。

#### 7. 数据处理与持久化 (Data Handling & Persistence)

1. **生成ID**：系统计算出当前 tags.json 中最大的标签ID，将其加1作为新标签的ID。这个ID将永不复用。
2. **保存封面**：将预览区最终确认的图片（无论是来自视频截图还是粘贴）保存到 data/tag_images/ 目录下，并命名为 [新ID].webp。
3. **更新 tags.json**：
   - 如果用户输入了新的分组名，则先在JSON中创建该分组的键和空数组。
   - 将包含新标签 {id, keywords, description} 的对象追加到对应分组的数组中。
4. **更新 files.json**：找到当前视频的条目，将新标签的ID追加到其 tags 数组中。