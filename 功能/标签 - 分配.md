#### 1. 功能概述 (Feature Overview)

**分配标签**是为视频添加元数据的核心枢纽。此功能提供一个高效的、以键盘快捷键为中心的模态对话框，允许用户为当前视频快速地**添加**或**移除**标签。

此对话框引入了“**固化常用标签**”区域，用户可以将个人最高频使用的标签固定在此处，并通过专属快捷键实现一键分配，极大地提升了标签分配的效率。

#### 2. 触发机制 (Triggering Mechanism)

在主播放器界面，当视频正在播放或暂停时，按下快捷键 **Shift+G** (此快捷键可在 setting.json 中配置)，将以模态形式弹出“分配标签”对话框。

#### 3. UI 布局与设计原理 (UI Layout & Design Rationale)

对话框采用**多区域上下布局**，结构清晰，旨在引导用户完成从“快速选择”到“常规搜索”的流畅操作。

- **上部：固化常用区 (Pinned Favorites Pane)**：用户的个人快捷工具栏。
- **中部：当前分配区 (Current Assignment Pane)**：当前视频的标签状态总览。
- **下部：标签库浏览区 (Library Browser Pane)**：标准的搜索与选择区域。



```
+----------------------------------------------------------------------------------+
| 为当前视频分配标签                                                          [X]  |
+----------------------------------------------------------------------------------+
| ┌──────────────────────────────────────────────────────────────────────────────┐ |
| │ 常用标签 (Pinned)                                                            │ |
| │ +--------------------+ +--------------------+                                 │ |
| │ | 1 [img] 侧脸特写   ⓧ| | 2 [img] 微笑       ⓧ|  <- 可拖拽目标区域           │ |
| │ +--------------------+ +--------------------+                                 │ |
| └──────────────────────────────────────────────────────────────────────────────┘ |
+----------------------------------------------------------------------------------+
| ┌──────────────────────────────────────────────────────────────────────────────┐ |
| │ 已分配标签 (Assigned)                                                        │ |
| │ +-----------------+  +-----------------+                                     │ |
| │ | [img] 富士山  ⓧ |  | [img] 日落    ⓧ |                                     │ |
| │ +-----------------+  +-----------------+                                     │ |
| └──────────────────────────────────────────────────────────────────────────────┘ |
+----------------------------------------------------------------------------------+
| [ 🔍 搜索标签库...                                                           ]   |
|                                                                                  |
|                [    通用标签过滤与展示组件 (可拖拽源)    ]                       |
|                                                                                  |
+----------------------------------------------------------------------------------+
|                                                               [ 取消 ] [ 确定 ]  |
+----------------------------------------------------------------------------------+
```

#### 4. 核心交互工作流 (Core Interactive Workflow)

1. **启动**：用户按下 Shift+G，对话框弹出。
   - **常用标签区**加载用户已固化的标签列表。
   - **已分配标签区**加载当前视频已拥有的标签。
   - **标签库**加载所有标签，并自动排除掉**所有固化**和**所有已分配**的标签。
2. **快捷分配 (Quick Assign)**：用户按下 1 键。
   - **逻辑判断**：程序检查“常用标签”列表中第一个位置的标签（例如 侧脸特写）是否已在“已分配标签”区。
   - **若未分配**：侧脸特写 标签会被添加到“已分配标签”区。
   - **若已分配**：无任何操作。
3. **常规分配 (Standard Assign)**：用户在搜索框输入 雪，从下方标签库中点击 雪景 标签。
   - **交互结果**：雪景 标签从下方标签库消失，并出现在中部的“已分配标签”区。
4. **取消分配 (Unassign)**：用户点击“已分配标签”区中 富士山 标签的 ⓧ 图标。
   - **交互结果**：富士山 标签从“已分配标签”区消失，并重新出现在下方的标签库中。
5. **固化常用标签 (Pin a Tag)**：用户在下方标签库中，**按住鼠标左键拖拽** 海滩 标签，并将其拖到最上方的“常用标签”区域后释放。
   - **逻辑判断**：检查“常用标签”区是否已满10个。
   - **若未满**：海滩 标签被添加到“常用标签”区的末尾，获得一个新的快捷键编号，并从下方标签库消失。
   - **若已满**：弹出一个Toast提示“常用标签栏已满”。
6. **取消固化 (Unpin a Tag)**：用户点击“常用标签”区中 微笑 标签的 ⓧ 图标。
   - **交互结果**：微笑 标签从“常用标签”区消失，并重新出现在下方的标签库中。

#### 5. 关键组件与逻辑详解 (Key Component & Logic Breakdown)

- **固化常用标签区 (Pinned Favorites Pane)**
  - **数据源**：一个独立的、全局持久化的列表（例如，保存在 setting.json 或一个新的 pinned_tags.json 文件中），存储固化标签的ID序列。
  - **显示逻辑**：
    - 每个标签卡片前都显示其对应的快捷键 (1-5, Q, W, E, R, ~)。
    - 如果某个固化标签**已被当前视频分配**，则该标签卡片应**置灰**或降低透明度，以表示其“已激活”状态，但**绝不隐藏或打乱顺序**。
    - 卡片带 ⓧ 图标用于“取消固化”。
  - **拖拽目标**：此区域是可接受拖拽的目标（Drop Target）。
- **已分配标签区 (Current Assignment Pane)**
  - **数据源**：当前视频在 files.json 中的 tags 列表。
  - **交互**：卡片带 ⓧ 图标用于“取消分配”。
- **通用标签过滤与展示组件 (Library Browser Pane)**
  - **拖拽源**：此组件内的所有标签卡片现在都是可拖拽源（Draggable Source）。
  - **动态排除**：其 excluded_ids 属性接收一个**合并后**的ID集合，该集合是**“所有固化标签ID”**与**“所有已分配标签ID”**的并集。这确保了标签库中永远不会出现这两类标签。
- **快捷键上下文与稳定性**
  - 快捷键（1 到 ~）的映射关系是**固定**的，它只与标签在“固化常用标签”列表中的**位置**有关（第一个位置是1，第二个是2，以此类推）。
  - **这种映射关系不受任何标签的显示状态（如因已分配而置灰）影响**。即使用户按下一个已置灰标签的快捷键，程序也只是判断为无效操作，而不会将该快捷键错误地分配给下一个可见的标签。

#### 6. 数据流与持久化 (Data Flow & Persistence)

1. **会话状态**：对话框在内存中维护两个列表：
   - pinned_tags_session: 用户在本次会话中对常用标签的修改。
   - assigned_tags_session: 用户在本次会话中对视频已分配标签的修改。
2. **关闭逻辑**：
   - **点击【确定】**：
     - 将 pinned_tags_session 的最终状态写入全局配置文件。
     - 将 assigned_tags_session 的最终状态写入 files.json。
     - 关闭对话框。
   - **点击【取消】**：
     - 丢弃所有会话中的修改。
     - 关闭对话框。