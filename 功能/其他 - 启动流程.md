### 1. 痛点与动机

- 
- **痛点**：
  - 
  - **启动缓慢**：如果启动时就对所有视频进行哈希计算（Rescan），海量视频会导致软件启动卡顿数分钟。
  - **路径未配置**：初次使用或配置丢失时，软件不知道去哪里读取视频，也不知道文件删到哪里去。
  - **脏数据干扰**：已删除或已编辑归档的视频如果再次出现在播放列表中，会严重干扰用户体验。
- **动机**：
  - 
  - **极致轻量化**：启动时仅读取文件系统的基础属性（路径、创建时间），实现秒级启动。
  - **安全引导**：强制路径检查，确保核心功能（删除、导出、截图）有“家”可归。
  - **智能恢复**：记忆用户的上次使用习惯（音量、播放模式），提供无缝体验。

### 2. 核心流程概要

1. 
2. **配置与路径检查**（阻断性检查）。
3. **数据文件加载**（配置、元数据、历史）。
4. **轻量级磁盘扫描**（仅路径与时间，排除黑名单）。
5. **内存列表构建**（随机、最新、元数据映射）。
6. **环境恢复与UI渲染**（音量、快捷键、视口）。
7. **开始播放**（默认随机模式）。

### 3. 详细启动步骤

#### 步骤 1：配置完整性检查 (Pre-flight Check)

- 
- **读取**：setting.json。
- **判断**：检查以下四个核心路径是否为空或无效：
  1. 
  2. data_path / video_source (视频源目录)
  3. pending_delete_path (待删除目录)
  4. processed_path (已处理目录)
  5. screenshot_export_path (截图导出目录)
- **分支**：
  - 
  - **若任意路径未配置**：**中断启动流程**，直接进入 **“路径设置页面”**（参考设置界面文档），强制用户配置完成后才可继续。
  - **若路径有效**：进入步骤 2。

#### 步骤 2：加载数据文件 (Load Data)

并行或顺序读取以下 JSON 文件到内存：

- 
- **setting.json**：获取 skip_frame 配置、global_volume、last_play_mode、快捷键映射。
- **files.json**：获取视频的元数据（Hash, Tags, Likes, Favorites, Rotation 等）。
- **Recent.json**：获取最近播放的历史记录（Path List）。

#### 步骤 3：轻量级磁盘扫描 (Lightweight Scan)

- 
- **目标**：用户配置的视频源目录。
- **获取信息**：仅获取 **文件路径 (File Path)** 和 **创建时间 (Creation Time)**。
- **黑名单过滤 (Blacklist Filtering)**：
  - 
  - 在遍历目录树时，实时比对当前文件夹路径。
  - **逻辑**：如果当前路径 **等于** 或 **属于** pending_delete_path 或 processed_path。
  - **动作**：**跳过 (Skip)**。不读取其中的任何文件，确保“回收站”和“成品库”不仅入播放列表。

#### 步骤 4：构建内存播放列表 (Build In-Memory Lists)

基于扫描结果和加载的数据，在内存中构建核心列表：

1. 
2. **随机播放列表 (默认)**：
   - 
   - 包含扫描到的所有有效视频文件。
   - 也就是“全量池”。
3. **最新视频列表 (Top 100)**：
   - 
   - 对全量池按 creation_time 倒序排列。
   - 截取前 100 个。
4. **元数据列表 (点赞/精品)**：
   - 
   - 使用扫描到的 file_path 与 files.json 中的记录进行匹配（此时暂不计算Hash，仅靠路径关联）。
   - 筛选出 is_favorite == true 的放入 **精品列表**。
   - 筛选出 like_count > 0 的放入 **点赞列表**（并按分数分段）。
   - *注意：如果有元数据但磁盘没扫描到文件，视为“丢失”，暂不显示。*
5. **最近播放列表**：
   - 
   - 读取 Recent.json，并过滤掉磁盘上已不存在的文件。

#### 步骤 5：环境与状态恢复 (Restore State)

- 
- **音量**：应用 global_volume 设置。
- **快捷键**：注册 setting.json 中定义的快捷键映射，若无则加载默认。
- **播放模式 (Play Mode)**：
  - 
  - 读取 last_play_mode。
  - 若为 "Skip"（跳帧），UI 图标显示为“三竖线”，加载 skip_frame 配置准备切片。
  - 若为 "Normal"（正常），UI 图标显示为“右箭头”。
- **视口 (Viewport)**：
  - 
  - 初始化视口大小（通常等待第一个视频加载时根据自适应规则调整，启动瞬间可设为默认 720p 占位）。
- **统计信息**：
  - 
  - 计算视频总大小，准备在设置界面显示。

#### 步骤 6：启动播放 (Start Playback)

- 
- **默认行为**：将播放器的内部列表状态置为 **“随机播放列表”**。
- **动作**：
  1. 
  2. 从随机列表中随机选取一个视频。
  3. 加载视频（此时根据视频分辨率触发 **视口自适应**）。
  4. 检查是否存在 **截图/自动生成的截图**（若无则后台触发生成 9 张预览图）。
  5. **开始播放**。

### 4. 流程图

codeMermaid



```
graph TD
    Start[软件启动] --> ConfigCheck{检查4个核心路径}
    
    ConfigCheck -- 路径为空 --> SetupUI[进入路径设置界面]
    SetupUI --> UserConfig[用户配置完成] --> ConfigCheck
    
    ConfigCheck -- 路径有效 --> LoadData[加载 JSON: Settings, Files, Recent]
    
    LoadData --> ScanDisk[扫描视频源目录]
    ScanDisk --> Filter{是待删除/已处理目录?}
    Filter -- 是 --> Skip[跳过不读取]
    Filter -- 否 --> GetInfo[获取路径 & 创建时间]
    
    GetInfo --> BuildLists[构建内存列表]
    BuildLists --> L1[随机列表 (全量)]
    BuildLists --> L2[最新列表 (Top 100)]
    BuildLists --> L3[元数据关联 (点赞/精品)]
    BuildLists --> L4[最近列表 (Valid Check)]
    
    L3 --> RestoreState[恢复状态]
    RestoreState --> SetVol[设置音量]
    RestoreState --> SetKeys[注册快捷键]
    RestoreState --> SetMode[设置播放模式 (跳帧/正常)]
    
    SetMode --> FinalAction[进入随机模式]
    FinalAction --> PickVideo[随机选取视频]
    PickVideo --> AdaptView[视口自适应]
    AdaptView --> Play[开始播放]
```