### 1. 痛点与动机

- **痛点**：
  - 视频截图通常需要作为素材导出，但源视频方向（如竖屏视频在横屏显示器）可能导致截图方向歪倒，后期处理繁琐。
  - 刚打开视频时“截图轨道”空空如也，用户无法快速预览视频概貌。
  - 误删操作容易导致包含重要截图的视频片段被遗弃。
- **动机**：
  - 提供**纯净的源分辨率截图**，并在导出环节提供**独立的旋转控制**（预览+批处理）。
  - 通过**自动生成关键帧**（9等分）填充轨道，提升内容预览效率。
  - 在裁剪编辑时提供**视觉警示**依据，防止误删已标记重点（已截图）的片段。

### 2. 功能概要

- **源画质截图**：截取视频原始分辨率、原始方向的图像，保存至数据目录。
- **自动补全**：视频首次加载若无截图，自动生成 9 张等间隔截图。
- **智能导出**：将当前视频的所有截图导出到指定目录。首次导出或强制设置时，提供旋转预览与配置（0°, 90°, 180°, 270°）。已设置则直接导出。
- **交互反馈**：截图与导出操作均有Toast 提示；裁剪模式下提供误删警示。

### 3. Setting 配置与数据存储

- **配置文件** ()：
  - setting.json: screenshot_export_path 定义导出根目录。
  - files.json: screenshot_rotation 记录导出旋转角（null/0/90/180/270）。
- **存储逻辑**：
  - **源文件存储**：data/screenshots/[Hash前两位]/[完整Hash]/
  - **旋转**：文件本体保持**原始扫描线方向**，不应用旋转。
  - **命名**：
    - 手动截图：[毫秒时间戳]_m.webp (Manual)
    - 自动截图：[毫秒时间戳]_a.webp (Auto)
    - 以便区分（手动）有价值的截图，后续其他操作，可以依赖这个命名。
  - **旋转参数记录**：
    - null / 不存在此文件的元数据：未设置（触发弹窗）。
    - 0, 90, 180, 270：用户设定的旋转角度。
- **导出处理逻辑**：
  - 仅在执行导出指令时，程序读取源图片到**内存**。
  - 在**内存中**应用 screenshot_rotation 定义的旋转角度。
  - **自动归档**：在导出根目录下创建以 **[完整Hash]** 命名的子文件夹，将处理后的图片写入其中。

### 4. 快捷键

- **执行截图**：E
  - 截取当前帧，无阻断，仅 Toast 提示。
- **快捷导出 (Smart Export)**：Ctrl + E
  - 智能判断：若已配置过旋转，直接导出；若未配置，弹出设置窗。
- **强制配置导出 (Force Export)**：Alt + E
  - 忽略已有配置，强制弹出设置窗（用于修正旋转角度）。

### 5. 交互逻辑

| 场景         | 用户/系统操作    | 内部逻辑                                                     | UI 变化                                                      | 数据变化                         |
| ------------ | ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | -------------------------------- |
| **视频加载** | 打开视频         | 1. 检查 data/screenshots/xx/xxxx/目录是否存在，目录下是否有图片。<br>2. **false**：自动计算 9 个等分时间点，后台截取源分辨率图像。 | 截图轨道加载并显示截图（含自动生成的）。                     | 磁盘生成 9 张 _a.webp 文件。     |
| **手动截图** | 按 E             | 1. 截取当前源视频帧（不带旋转处理）。<br>2. 保存至数据目录。 | 截图轨道新增图片；<br/>显示 Toast 提示。张图。               | 磁盘新增 _m.webp 文件。          |
| **快捷导出** | 按 Ctrl + E      | 读取 screenshot_rotation。<br/>1. **若已有值**：创建 [Hash] 文件夹 -> 读取源图 -> 内存旋转 -> 写入该文件夹。<br/>2. **若为 null**：触发“导出配置弹窗”。。 | 1. 若直接导出：显示 Toast “导出成功”。<br>2. 若未配置：弹出配置模态框。 | 目标路径下生成文件夹及图片。     |
| **强制配置** | 按下 Alt + E     | 1. 忽略已有配置，强制打开“导出配置弹窗”。                    | 弹出配置模态框。                                             | 无直接数据变化，等待确认。       |
| **确认导出** | 在弹窗点击“确认” | 1. 记录选择的角度到 screenshot_rotation。<br/>2. 创建 [Hash] 文件夹 -> 读取源图 -> 内存旋转 -> 写入该文件夹。 | 1. 关闭弹窗。<br>2. 显示 Toast “导出成功”。                  | 更新元数据 screenshot_rotation。 |

### 6. UI 说明

#### 6.1 主界面调整

- 所有成功/状态提示均使用 **Toast** 组件，不阻挡用户操作。

#### 6.2 截图导出配置弹窗

- **触发时机**：
  - 用户点击导出且元数据中无旋转记录时。
  - 用户按下 Alt + e 时。
- **布局**：
  - **顶部**：四个选项按钮/单选框 0°, 90°, 180°, 270°。
    - 若首次打开，默认选中 0°。
    - 若强制打开，默认选中当前记录的值。
  - **中部**：**预览滚动区**。
    - 显示当前视频所有截图的缩略图。
    - 实时根据顶部选项的选择进行旋转渲染（即：用户选 90°，预览区的图就顺时针转 90°）。
    - 目的：让用户直观确认导出的图片方向是否正确。
  - **底部**：确认导出 按钮。

### 7. 数据处理细节

- **截图与视频旋转的关系**：
  - **存储层**：data/screenshots/... 下的 .webp 永远是视频原始方向（Raw）。
  - **导出层**：仅在导出到 screenshot_export_path 时，根据 screenshot_rotation 进行图像旋转处理。
- **导出目录结构**：
  - 假设全局导出路径为 D:/Export，视频 Hash 为 a1b2c3d4e5。
  - 导出后的结构为：D:/Export/a1b2c3d4e5/123456_m.webp。
  - **一致性**：使用 Hash 作为文件夹名可以避免文件名特殊字符问题，并与数据库 ID 保持对应。
- **自动生成逻辑**：
  - 生成的 9 张图也保存在 data/screenshots/[Hash前两位]/[完整Hash]/下。
  - _a.webp 与 _m.webp 在文件操作（如封面设置、导出/、删除逻辑）上享有同等地位。
- **文件冲突**：
  - 导出时，如果目标文件夹已存在同名文件，**直接覆盖**（Rewrite），不弹窗询问。