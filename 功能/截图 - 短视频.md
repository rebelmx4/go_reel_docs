### 1. 痛点与动机 (Pain Points & Motivations)

- **痛点**：静态截图无法捕捉动态瞬间；外部录屏软件操作繁琐，与播放器脱节。
- **动机**：提供一种无缝集成的、**沉浸式**的视频片段录制体验，确保用户在捕捉素材时不受干扰，并且录制前后播放器状态保持一致。

### 2. 功能概要 (Feature Overview)

- **纯快捷键驱动**：无UI按钮，完全通过快捷键 R (开始/停止) 和 Shift+R (取消) 控制。
- **专注录制模式**：一旦开始录制，应用将进入一个“锁定”状态，禁用所有其他快捷键和UI交互，让用户专注于录制过程。
- **状态保存与恢复**：系统会自动记录录制前的播放模式（如“跳帧模式”），在录制期间切换到标准播放，录制结束后无缝恢复到之前的模式。
- **自动结束机制**：若录制过程中视频自然播放完毕，系统将自动停止并保存录制，无需用户干预。
- **统一存储与导出**：录制的视频片段与截图文件统一管理，并集成到现有的素材导出流程中。

### 3. 核心配置与数据存储 (Core Configuration & Data Storage)

#### A. 快捷键 (Key Bindings - From setting.json)

- record_clip: R (切换录制状态：开始/停止)
- cancel_record: Shift+R (取消当前录制，不保存并恢复状态)

#### B. 数据存储路径 (Storage Path)

- **主目录**：data/screenshots/
- **具体视频目录**：data/screenshots/[Hash前两位]/[完整Hash]/
  - 录制的视频片段与该视频的所有截图共享此文件夹。

#### C. 文件命名规范 (File Naming Convention)

- **录制片段**：v_[毫秒时间戳].mp4
  - **前缀 v_**：明确标识为视频片段。
  - **时间戳**：使用**开始录制时**的开始帧毫秒时间戳。
  - **示例**：v_1500.mp4

### 4. 录制流程与状态管理 (Recording Flow & State Management)

这是该功能的核心，描述了从触发到结束的完整生命周期。

#### 步骤 1: 开始录制 (按下 R)

1. **保存当前状态**：系统立即记录播放器当前的状态，特别是**播放模式**（例如，是否处于 skip_frame 跳帧播放模式）。
2. **重置播放模式**：无论之前处于何种模式，播放器强制切换到**标准、连续的播放模式** (1x 速度)，以确保录制内容的流畅性。
3. **进入锁定状态**：
   - **禁用所有其他快捷键**：包括播放控制 (WASD, Space)、列表切换 (1-6)、截图 (E)、标签 (T) 等所有非录制相关的快捷键。
   - **禁用所有UI交互**：主播放器界面和侧边列表的所有按钮、进度条拖动、音量调节等均变为不可点击状态。
4. **启动UI反馈**：
   - 在视频视口的**右上角**显示OSD（On-Screen Display）指示器，格式为 🔴 REC 00:00:00，计时器从零开始。
5. **开始捕获**：后台开始捕获视频流。

#### 步骤 2: 录制期间

- 视频持续以标准模式播放。
- 右上角的OSD计时器实时更新。
- 应用处于“只读”状态，仅响应 R (停止) 和 Shift+R (取消) 两个快捷键。

#### 步骤 3: 停止录制 (两种情况)

- **情况 A: 手动停止 (再次按下 R)**
  - 系统在当前帧停止捕获视频流。
- **情况 B: 自动停止 (视频播放结束)**
  - 播放器触发 onEnded 事件，系统自动停止捕获。

#### 步骤 4: 录制完成与状态恢复

1. **保存文件**：将捕获的视频流编码并保存为 .mp4 文件到指定的素材目录。
2. **退出锁定状态**：重新启用所有之前被禁用的快捷键和UI交互。
3. **恢复播放器状态**：将播放器模式**恢复到步骤1中保存的状态**。例如，如果录制前是“跳帧模式”，则播放器恢复为“跳帧模式”。
4. **移除UI反馈**：右上角的OSD指示器消失。
5. **显示Toast提示**：在界面弹出短暂的 Toast 提示，内容为“录制片段已保存”。

#### 特殊情况: 取消录制 (按下 Shift+R)

1. **立即终止**：录制过程被立即中断。
2. **丢弃数据**：所有已捕获的临时视频流数据被丢弃，不生成任何文件。
3. **状态恢复与解锁**：与正常完成录制一样，系统会立即退出锁定状态并恢复之前的播放器状态。
4. **UI反馈**：OSD指示器消失，弹出一个 Toast 提示，如“录制已取消”。

### 5. 导出逻辑联动 (Export Logic Integration)

- 此部分的逻辑保持不变。当用户使用 Ctrl+E 或 Alt+E 导出素材时，系统会自动扫描并包含 data/screenshots/[Hash]/ 目录下的所有 v_*.mp4 文件，将其原样复制到导出目录中。

### 6. 总结 (Summary)

| 特性               | 录制功能 (Recording)                       | 截图功能 (Screenshot)      |
| ------------------ | ------------------------------------------ | -------------------------- |
| **产物**           | .mp4 视频片段                              | .webp 静态图片             |
| **快捷键**         | R (切换录制), Shift+R (取消)               | E (单张截图)               |
| **命名规范**       | v_[时间戳].mp4                             | [时间戳]_m.webp / _a.webp  |
| **存储路径**       | data/screenshots/[Hash]/                   | data/screenshots/[Hash]/   |
| **UI 反馈**        | 右上角OSD计时器, 进入/退出 **锁定模式**    | 顶部 Toast 提示            |
| **核心机制**       | **状态保存与恢复**，播放模式强制为标准模式 | 截取当前帧，不改变播放状态 |
| **录制中可操作性** | **不可操作** (除停止/取消外)               | **完全可操作**             |
| **取消操作**       | Shift+R (丢弃片段并恢复状态)               | 无                         |