### 1. 痛点与动机

- **痛点**：
  - 视频文件的默认缩略图（通常是第 0 帧）往往是黑屏或片头Logo，无法代表视频内容。
  - 在“精品”、“最新”、“点赞”等基于 Grid（网格）视图的列表中，如果缺乏有效的封面，用户体验极差，无法快速辨识视频。
- **动机**：
  - 建立一套**分级封面策略**（手动 > 默认）。
  - 实现**懒加载生成**机制，仅在视频出现在列表中时才生成封面，节省资源。
  - 选取视频 **20%** 进度处作为默认封面，通常能避开片头，截取到正片内容。

### 2. 功能概要

- **双层封面机制**：系统区分“默认生成的封面”和“用户手动设置的封面”。
- **按需生成**：在播放模式下不生成封面；仅当视频出现在需要展示缩略图的文件列表（如最近、精品、点赞）中时，触发查找或生成逻辑。
- **持久化存储**：生成的封面会保存到本地，下次直接读取。

### 3. 数据存储与命名规范

- **存储路径**：data/covers/ 
- **文件命名逻辑**：基于视频文件的 **Hash** 值。
  1. **默认封面 (Default)**：文件名格式为 [Hash]\_d.webp（_d 代表 Default）。
     - **生成规则**：截取视频时长 **20%** 时间点的画面。
     - **特性**：一旦生成，不会自动删除，除非视频文件本身被清理。
  2. **手动封面 (Manual)**：文件名格式为 [Hash].webp。
     - **来源**：用户在“截图轨道”上手动指定。
     - **特性**：优先级高于默认封面。

### 4. 显示优先级逻辑

当UI需要在列表中渲染某个视频的封面时，遵循以下 **“三步走”** 逻辑：

1. **查找手动封面**：
   - 检查是否存在 [Hash]。
   - **若存在**：直接使用。
   - **若不存在**：进入第 2 步。
2. **查找默认封面**：
   - 检查是否存在 [Hash]_d.webp。
   - **若存在**：直接使用。
   - **若不存在**：进入第 3 步。
3. **生成并保存**：
   - 后台静默加载视频，截取 **20%** 处的帧。
   - 保存为 [Hash]_d 文件。
   - 使用该图片进行显示。

### 5. 交互与操作

#### 5.1 手动设置封面

- **操作区域**：**截图轨道**（Screenshot Track）。
- **操作方式**：
  - 用户在截图轨道上浏览自动生成的截图或手动截取的图片。
  - 选中某张截图，将其“设为封面”。
- **结果**：系统将该图片复制/保存为 [Hash].webp。
- **注意**：手动设置封面**不会**删除已存在的默认封面（_d 文件保留），方便用户取消手动设置后回退到默认状态。

#### 5.2 裁剪联动 (关联功能)

- **场景**：用户使用裁剪功能（Clip & Crop）生成了新视频，或者修改了原视频（Hash 发生变化）。
- **逻辑**：
  - **裁剪时**：如果原视频有对应的封面（手动或默认），需检查确认。
  - **Hash 变更**：若视频内容改变导致 Hash 改变，系统必须同步重命名或处理 covers/ 目录下对应的封面文件，确保封面与新 Hash 重新关联，防止封面丢失或错乱。

### 6. 总结

| 特性           | 默认封面 (Default)               | 手动封面 (Manual)  |
| -------------- | -------------------------------- | ------------------ |
| **文件名标识** | [Hash]_d.webp                    | [Hash].webp        |
| **生成时机**   | 视频首次出现在列表时 (懒加载)    | 用户主动操作时     |
| **取景位置**   | 视频时长的 20%                   | 用户指定的任意截图 |
| **优先级**     | 低 (备选)                        | **高 (首选)**      |
| **持久性**     | 永久保存，不随手动封面覆盖而删除 | 永久保存           |