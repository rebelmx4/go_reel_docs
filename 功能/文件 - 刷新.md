### 1. 痛点与动机

- 
- **痛点**：
  - 
  - **数据冗余**：随着视频库扩容，如果每个被播放或扫描过的视频都记录在 database 中，files.json 会迅速膨胀，影响读写性能。
  - **同步滞后**：用户在操作系统层面的文件操作（移动、重命名、删除）无法即时反映在软件中，导致“找不到文件”或列表混乱。
- **动机**：
  - 
  - **元数据极简主义**：确立“仅存储用户产生的价值”原则。对于单纯的“存在”或“被播放”，交给文件系统管理；只有用户投入了精力（点赞、收藏、旋转、截图等）的数据才值得被持久化。
  - **深度同步**：通过哈希（Hash）比对，实现元数据与文件实体的“重绑定”，确保文件改名后，用户的点赞和收藏不丢失。

### 2. 功能概要

- 
- **触发方式**：快捷键 **F5**（无 UI 按钮）。
- **核心逻辑**：
  - 
  - 扫描指定目录下的所有视频文件。
  - 计算文件哈希，与 files.json 中的元数据进行比对。
  - **黑名单过滤**：自动跳过 setting.json 中配置的 pending_delete_path（待删除）和 processed_path（已处理）目录。
- **轻量化原则**：只有包含“有价值数据”的视频信息才会保留在 files.json 中，纯新增或仅播放过的“白板”视频只存在于内存列表中。

### 3. 数据存储策略（核心变更）

#### 3.1 “有价值数据”的定义

只有当视频满足以下**任意一个**条件时，才会被视为“有价值”，并记录/更新到 files.json：

1. 
2. **点赞**：like_count > 0。
3. **收藏**：is_favorite == true。
4. **标签**：tags 列表不为空。
5. **旋转**：rotation != 0。
6. **截图导出设置**：screenshot_rotation 有值。
7. **裁剪历史**：存在关联的裁剪元数据。

#### 3.2 写盘逻辑

- 
- **新增视频**：若无上述数据，**不写入** files.json。
- **仅播放视频**：播放行为不视为产生价值，**不写入**。
- **数据清洗**：在刷新过程中，如果发现 files.json 中某些条目已失去所有价值（例如用户取消了收藏，且点赞衰减为 0，且无标签），应从 files.json 中**移除**该条目。

### 4. 扫描与处理流程（四种情况）

刷新时会全量扫描磁盘文件，并与内存中的元数据进行碰撞：

#### 情况 1：纯新增 (New Files)

- 
- **现象**：磁盘上有该文件，files.json 中无此哈希。
- **处理**：
  - 
  - 将其加载到内存中的“随机播放列表”和“最新视频列表”。
  - **不写入 files.json**（遵循轻量化原则）。

#### 情况 2：移动或重命名 (Move / Rename)

- 
- **现象**：磁盘文件的哈希值在 files.json 中**能找到**，但路径（Path）不匹配。
- **处理**：
  - 
  - 说明这是用户已标记过（有价值）的视频，只是改了位置。
  - **更新** files.json 中对应节点的 file_path 为当前磁盘的新路径。
  - 保持原有的点赞、收藏等数据有效。

#### 情况 3：删除或内容变更 (Delete / Modified)

- 
- **现象**：files.json 中有记录，但按照记录的 file_path 在磁盘找不到文件，且反向通过哈希也找不到对应文件。
- **处理**：
  - 
  - 说明文件已被物理删除或内容被篡改导致哈希变动且不再匹配原数据。
  - **删除** files.json 中对应的条目，清除无效数据。

#### 情况 4：重复或追加 (Duplicate)

- 
- **现象**：磁盘文件的哈希在 files.json 中已存在，且路径不同（即同一个视频存了多份）。
- **处理**：
  - 
  - 在 files.json 对应节点的 paths 数组中追加当前路径（如果支持多路径），或更新为最新扫描到的路径。

### 5. UI 交互体验

由于全量计算哈希耗时较长，刷新过程是一个**模态（Modal）**体验：

- 
- **全屏覆盖**：按下 F5 后，切换到一个覆盖整个软件视窗的加载页面。
- **进度展示**：
  - 
  - **进度条**：显示扫描进度。
  - **当前扫描目录**：显示正在处理的文件夹名称。
- **防闪烁优化**：
  - 
  - 由于扫描速度极快（尤其是 SSD 上），文件名跳动太快会造成视觉疲劳。
  - **逻辑**：每处理 **100** 个文件，才更新一次 UI 上显示的“当前扫描文件夹名”。

### 6. 总结流程图

codeMermaid



```
graph TD
    A[按下 F5] --> B[显示全屏遮罩]
    B --> C[遍历视频目录]
    C --> D{是否为待删除/已处理目录?}
    D -- 是 --> E[跳过 (Skip)]
    D -- 否 --> F[计算文件 Hash]
    
    F --> G{Hash 在 files.json 存在?}
    
    G -- 存在 (有价值数据) --> H[更新 JSON 中的 file_path]
    H --> I[内存列表更新]
    
    G -- 不存在 --> J{包含有价值数据?}
    J -- 是 (理论上不可能, 除非内存新建) --> K[写入 JSON]
    J -- 否 (纯新文件) --> L[仅加载入内存列表 (不写库)]
    
    M[遍历 files.json 检查僵尸条目] --> N{对应文件是否存在?}
    N -- 否 --> O[删除 JSON 条目]
    
    O --> P[刷新结束，关闭遮罩]
```