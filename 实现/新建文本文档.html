<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æœ€ç»ˆç‰ˆæ’­æ”¾å™¨ï¼šåŸå§‹æ–¹å‘æˆªå›¾</title>
    <style>
        body { font-family: "Segoe UI", sans-serif; background: #1a1a1a; color: #ddd; text-align: center; margin: 0; padding: 20px; user-select: none; }
        
        /* æ’­æ”¾å™¨å®¹å™¨ */
        .player-wrap {
            position: relative;
            width: 800px;
            height: 450px;
            background: #000;
            margin: 0 auto 10px;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        video {
            max-width: 100%;
            max-height: 100%;
            transition: transform 0.3s ease-in-out;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            width: 800px; height: 10px; background: #444; margin: 0 auto 20px;
            position: relative; cursor: pointer; border-radius: 5px; transition: height 0.1s;
        }
        .progress-container:hover { height: 15px; }
        .progress-filled { height: 100%; background: #ff0000; width: 0%; border-radius: 5px; pointer-events: none; }

        /* é¢„è§ˆå¼¹çª— */
        .thumbnail-popup {
            position: absolute; bottom: 25px; left: 0; width: 160px; height: 90px;
            background: #000; border: 2px solid #fff; border-radius: 4px;
            display: none; pointer-events: none; z-index: 100;
            transform: translateX(-50%);
        }
        .thumbnail-popup canvas { width: 100%; height: 100%; object-fit: contain; background: #000;}
        .time-tooltip { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); color: #fff; font-size: 12px; }

        /* æ¡†é€‰ä¸æ§åˆ¶ */
        .crop-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; cursor: crosshair; display: none; }
        .selection-box { border: 2px dashed #00ff00; background: rgba(0, 255, 0, 0.2); position: absolute; display: none; pointer-events: none; }
        
        .controls { width: 800px; margin: 10px auto; background: #2a2a2a; padding: 15px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; }
        .file-upload { position: relative; overflow: hidden; display: inline-block; }
        .file-upload input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%;}
        
        button, .btn { padding: 8px 12px; cursor: pointer; background: #444; color: #fff; border: 1px solid #555; border-radius: 4px; }
        button:hover { background: #555; }
        .btn-primary { background: #007bff; border-color: #007bff; }
        .group { border-right: 1px solid #555; padding-right: 10px; display: flex; gap: 5px; }
        .group:last-child { border: none; }
        
        #previewArea { margin-top: 20px; border-top: 1px solid #444; padding-top: 10px; text-align: left; width: 800px; margin: 20px auto;}
        img.preview { border: 1px solid #fff; max-width: 150px; margin: 5px; vertical-align: top; background: #000; }
    </style>
</head>
<body>

<div class="player-wrap" id="playerContainer">
    <video id="myVideo"></video>
    <div class="crop-overlay" id="cropOverlay">
        <div class="selection-box" id="selectionBox"></div>
    </div>
</div>

<div class="progress-container" id="progressWrap">
    <div class="progress-filled" id="progressFill"></div>
    <div class="thumbnail-popup" id="thumbPopup">
        <canvas id="thumbCanvas" width="160" height="90"></canvas>
        <div class="time-tooltip" id="thumbTime">00:00</div>
    </div>
</div>

<div class="controls">
    <div class="group">
        <div class="file-upload btn btn-primary">
            <span>ğŸ“‚ é€‰æ‹©æœ¬åœ°è§†é¢‘</span>
            <input type="file" id="fileInput" accept="video/*">
        </div>
    </div>

    <div class="group">
        <button onclick="playPause()">â¯ æ’­æ”¾/åœ</button>
        <button onclick="rotateVideo()">ğŸ”„ æ—‹è½¬(è§†è§‰)</button>
    </div>
    
    <div class="group">
        <button onclick="stepFrame(-1)">â® -1å¸§</button>
        <button onclick="stepFrame(1)">+1å¸§ â­</button>
    </div>

    <div class="group">
        <!-- æ³¨æ„ï¼šè¿™é‡Œæ”¹åä¸ºåŸå§‹æˆªå›¾ -->
        <button onclick="takeRawSnapshot()" style="background:#28a745; border-color:#28a745">ğŸ“· åŸå§‹æˆªå›¾</button>
        <button onclick="toggleCropMode()" id="cropBtn">âœ‚ï¸ æ¡†é€‰(æ‰€è§å³æ‰€å¾—)</button>
    </div>
</div>

<div id="previewArea">
    <p style="color:#888; font-size:12px; margin:0 0 10px 0;">æˆªå›¾ç»“æœ (ç‚¹å‡»å¯ä¸‹è½½):</p>
</div>

<script>
    const video = document.getElementById('myVideo');
    const ghostVideo = document.createElement('video'); 
    const container = document.getElementById('playerContainer');
    const fileInput = document.getElementById('fileInput');
    
    // è¿›åº¦æ¡
    const progressWrap = document.getElementById('progressWrap');
    const progressFill = document.getElementById('progressFill');
    const thumbPopup = document.getElementById('thumbPopup');
    const thumbCtx = document.getElementById('thumbCanvas').getContext('2d');
    const thumbTime = document.getElementById('thumbTime');

    // æ¡†é€‰
    const cropOverlay = document.getElementById('cropOverlay');
    const selectionBox = document.getElementById('selectionBox');
    const cropBtn = document.getElementById('cropBtn');
    
    let currentDeg = 0;
    let isCropMode = false;
    let startX, startY, isDragging = false;
    let ghostSeeking = false;

    // --- 1. åŠ è½½ ---
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        video.src = url; video.load();
        ghostVideo.src = url; ghostVideo.muted = true;
        currentDeg = 0;
        video.style.transform = 'rotate(0deg)';
    });

    // --- 2. è¿›åº¦æ¡ä¸é¢„è§ˆ ---
    video.addEventListener('timeupdate', () => {
        if (video.duration) progressFill.style.width = (video.currentTime / video.duration) * 100 + '%';
    });
    progressWrap.addEventListener('click', (e) => {
        if (video.duration) {
            const rect = progressWrap.getBoundingClientRect();
            video.currentTime = ((e.clientX - rect.left) / rect.width) * video.duration;
        }
    });
    progressWrap.addEventListener('mousemove', (e) => {
        if (!video.duration) return;
        const rect = progressWrap.getBoundingClientRect();
        const hoverX = e.clientX - rect.left;
        const targetTime = (hoverX / rect.width) * video.duration;
        
        thumbPopup.style.display = 'block';
        thumbPopup.style.left = hoverX + 'px';
        thumbTime.innerText = formatTime(targetTime);

        if (!ghostSeeking && Math.abs(ghostVideo.currentTime - targetTime) > 0.5) {
            ghostSeeking = true;
            ghostVideo.currentTime = targetTime;
        }
    });
    progressWrap.addEventListener('mouseleave', () => thumbPopup.style.display = 'none');
    ghostVideo.addEventListener('seeked', () => {
        thumbCtx.drawImage(ghostVideo, 0, 0, 160, 90);
        ghostSeeking = false;
    });
    function formatTime(s) {
        const min = Math.floor(s / 60), sec = Math.floor(s % 60);
        return `${min}:${sec < 10 ? '0'+sec : sec}`;
    }

    // --- 3. æ§åˆ¶ä¸æ—‹è½¬ ---
    function playPause() { if(video.currentSrc) video.paused ? video.play() : video.pause(); }
    function stepFrame(n) { if(video.currentSrc) video.currentTime += (n * 0.042); }
    
    function rotateVideo() {
        if (!video.currentSrc) return;
        currentDeg = (currentDeg + 90) % 360;
        // ä»…å¤„ç†è§†è§‰ç¼©æ”¾ï¼Œä¸å½±å“æ•°æ®æµ
        let scale = 1;
        if (currentDeg % 180 !== 0) {
            scale = Math.min(container.offsetHeight / video.videoWidth, container.offsetWidth / video.videoHeight);
        }
        video.style.transform = `rotate(${currentDeg}deg) scale(${scale})`; 
    }

    // --- 4. å…³é”®ä¿®æ”¹ï¼šåŸå§‹æ–¹å‘å…¨å±æˆªå›¾ ---
    
    function getRawCanvas() {
        // åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ Canvas
        const canvas = document.createElement('canvas');
        // å¼ºåˆ¶ä½¿ç”¨è§†é¢‘åŸå§‹åˆ†è¾¨ç‡
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        // ç›´æ¥ç”»ï¼Œä¸è¿›è¡Œä»»ä½• translate æˆ– rotate
        // è¿™æ ·æ‹¿åˆ°çš„å°±æ˜¯è§†é¢‘æ–‡ä»¶é‡Œæœ€åŸæœ¬çš„é‚£ä¸€å¸§
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        return canvas;
    }

    function takeRawSnapshot() {
        if (!video.currentSrc) return;
        const canvas = getRawCanvas();
        saveImage(canvas.toDataURL('image/png'), 'raw_snap');
    }

    // --- 5. è¾…åŠ©ï¼šè§†è§‰æ—‹è½¬åçš„Canvas (ä»…ç”¨äºæ¡†é€‰è®¡ç®—) ---
    function getVisualCanvas() {
        // è¿™ä¸ªå‡½æ•°ä¾ç„¶ä¿ç•™æ—‹è½¬é€»è¾‘ï¼Œç”¨äºâ€œæ‰€è§å³æ‰€å¾—â€çš„æ¡†é€‰
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const w = video.videoWidth, h = video.videoHeight;
        if (currentDeg === 90 || currentDeg === 270) {
            canvas.width = h; canvas.height = w;
        } else {
            canvas.width = w; canvas.height = h;
        }
        ctx.save();
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(currentDeg * Math.PI / 180);
        ctx.drawImage(video, -w / 2, -h / 2, w, h);
        ctx.restore();
        return canvas;
    }

    // --- 6. æ¡†é€‰é€»è¾‘ (ä¿æŒ Visual æ¨¡å¼) ---
    function toggleCropMode() {
        if (!video.currentSrc) return;
        isCropMode = !isCropMode;
        if (isCropMode) {
            cropOverlay.style.display = 'block'; video.pause();
            cropBtn.style.background = "#d9534f"; cropBtn.innerText = "âŒ å–æ¶ˆ";
        } else {
            cropOverlay.style.display = 'none'; selectionBox.style.display = 'none';
            cropBtn.style.background = "#555"; cropBtn.innerText = "âœ‚ï¸ æ¡†é€‰";
        }
    }
    
    cropOverlay.addEventListener('mousedown', (e) => {
        isDragging = true;
        const rect = cropOverlay.getBoundingClientRect();
        startX = e.clientX - rect.left; startY = e.clientY - rect.top;
        selectionBox.style.display = 'block'; selectionBox.style.width = '0'; selectionBox.style.height = '0';
        selectionBox.style.left = startX + 'px'; selectionBox.style.top = startY + 'px';
    });
    
    cropOverlay.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const rect = cropOverlay.getBoundingClientRect();
        const curX = e.clientX - rect.left, curY = e.clientY - rect.top;
        selectionBox.style.width = Math.abs(curX - startX) + 'px';
        selectionBox.style.height = Math.abs(curY - startY) + 'px';
        selectionBox.style.left = Math.min(curX, startX) + 'px';
        selectionBox.style.top = Math.min(curY, startY) + 'px';
    });

    cropOverlay.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        const box = selectionBox.getBoundingClientRect();
        if (box.width < 5) return;
        
        // æ¡†é€‰æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨â€œè§†è§‰Canvasâ€ï¼Œå¦åˆ™æ¡†çš„å†…å®¹ä¼šå¯¹ä¸ä¸Š
        const visualCanvas = getVisualCanvas();
        const vRect = video.getBoundingClientRect();
        
        const scaleX = visualCanvas.width / vRect.width;
        const scaleY = visualCanvas.height / vRect.height;
        const offX = box.left - vRect.left;
        const offY = box.top - vRect.top;

        const cropCanvas = document.createElement('canvas');
        cropCanvas.width = box.width * scaleX;
        cropCanvas.height = box.height * scaleY;
        
        cropCanvas.getContext('2d').drawImage(
            visualCanvas, 
            offX * scaleX, offY * scaleY, cropCanvas.width, cropCanvas.height,
            0, 0, cropCanvas.width, cropCanvas.height
        );
        saveImage(cropCanvas.toDataURL(), 'crop');
        toggleCropMode();
    });

    function saveImage(dataUrl, prefix) {
        const img = document.createElement('img');
        img.src = dataUrl; img.className = 'preview';
        img.onclick = () => {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = prefix + '_' + Date.now() + '.png';
            a.click();
        };
        document.getElementById('previewArea').prepend(img);
    }
</script>

</body>
</html>